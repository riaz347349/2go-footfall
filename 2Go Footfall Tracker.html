<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>2GO Footfall & Age Counter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --accent: #111827;
      --accent-soft: #e5e7eb;
      --accent-strong: #064e3b;    /* dark green */
      --accent-main: #16a34a;      /* 2GO-ish green */
      --accent-main-soft: #dcfce7;
      --text: #111827;
      --muted: #6b7280;
      --danger: #b91c1c;
      --radius: 18px;
      --shadow: 0 10px 25px rgba(0,0,0,0.06);
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    body {
      margin: 0;
      background: radial-gradient(circle at top left, #bbf7d0, #f3f4f6 45%);
      color: var(--text);
      padding: 16px;
      font-size: 16px;
    }

    .app {
      max-width: 1100px;
      margin: 0 auto 40px;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px 18px 20px;
      margin-bottom: 20px;
      border-top: 4px solid var(--accent-main);
    }

    .card-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 14px;
      gap: 12px;
    }

    h1, h2, h3 {
      margin: 0;
    }

    h1 {
      font-size: 1.6rem;
      font-weight: 800;
      letter-spacing: 0.02em;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    h2 {
      font-size: 1.2rem;
      font-weight: 600;
    }

    h3 {
      font-size: 1rem;
      font-weight: 600;
    }

    .subtle {
      color: var(--muted);
      font-size: 0.9rem;
    }

    label {
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--muted);
      margin-bottom: 4px;
      display: block;
    }

    .inline-label {
      margin-bottom: 0;
      margin-right: 6px;
    }

    input, button {
      font-size: 1rem;
    }

    input[type="date"] {
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 8px 14px;
      outline: none;
      min-width: 160px;
      background: #fff;
    }

    input[type="date"]:focus {
      border-color: var(--accent-main);
      box-shadow: 0 0 0 2px rgba(22, 163, 74, 0.15);
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    .row > * {
      flex: 0 0 auto;
    }

    .spacer {
      flex: 1 1 auto;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 10px 18px;
      cursor: pointer;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      white-space: nowrap;
      transition: transform 0.05s ease, box-shadow 0.05s ease, background 0.1s, color 0.1s;
      font-size: 1rem;
    }

    .btn:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    .btn-primary {
      background: var(--accent-main);
      color: #fff;
      box-shadow: 0 4px 12px rgba(22, 163, 74, 0.35);
    }

    .btn-soft {
      background: var(--accent-main-soft);
      color: var(--accent-strong);
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--accent-soft);
      color: var(--muted);
    }

    .btn-danger {
      background: #fee2e2;
      color: var(--danger);
    }

    .btn-sm {
      padding: 8px 12px;
      font-size: 0.9rem;
    }

    .btn-block {
      width: 100%;
      justify-content: center;
    }

    .current-hour-label {
      font-size: 1.05rem;
      font-weight: 600;
      margin-top: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: var(--accent-main-soft);
      color: var(--accent-strong);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .current-hour-label span.badge {
      background: #22c55e;
      color: #f0fdf4;
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 999px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 700;
    }

    .quick-counter {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .quick-stat {
      border-radius: 14px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.9rem;
    }

    .quick-stat span.label {
      text-transform: uppercase;
      letter-spacing: 0.06em;
      font-size: 0.7rem;
      color: var(--muted);
    }

    .quick-stat span.value {
      font-size: 1.6rem;
      font-weight: 800;
    }

    .quick-stat--hour {
      background: #dcfce7;
      border-color: #bbf7d0;
    }

    .quick-stat--day {
      background: #eff6ff;
      border-color: #dbeafe;
    }

    .age-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    @media (min-width: 780px) {
      .age-grid {
        grid-template-columns: repeat(5, minmax(0, 1fr));
      }
    }

    .age-btn {
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      padding: 10px 10px;
      text-align: left;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-height: 80px;
      transition: background 0.1s, border-color 0.1s, transform 0.05s, box-shadow 0.05s;
      font-size: 0.95rem;
    }

    .age-btn span.label {
      font-size: 1rem;
      font-weight: 700;
    }

    .age-btn span.count {
      font-size: 0.85rem;
      color: var(--muted);
    }

    .age-btn:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    .age-btn.highlight {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.18);
    }

    /* Colour-coded age buttons */
    .age-btn.child {
      background: #eef2ff;
      border-color: #c7d2fe;
    }
    .age-btn.teen {
      background: #fef9c3;
      border-color: #facc15;
    }
    .age-btn.young_adult {
      background: #cffafe;
      border-color: #22d3ee;
    }
    .age-btn.adult_30 {
      background: #fee2e2;
      border-color: #f97373;
    }
    .age-btn.senior_60 {
      background: #f5f5f4;
      border-color: #e7e5e4;
    }

    .table-wrapper {
      width: 100%;
      overflow-x: auto;
      margin-top: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
      min-width: 650px;
    }

    th, td {
      border-bottom: 1px solid #e5e7eb;
      padding: 6px 8px;
      text-align: right;
    }

    th {
      text-transform: uppercase;
      font-size: 0.7rem;
      letter-spacing: 0.06em;
      color: var(--muted);
      background: #f9fafb;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    th:first-child, td:first-child {
      text-align: left;
      position: sticky;
      left: 0;
      background: #f9fafb;
      z-index: 2;
    }

    tbody tr:nth-child(odd) td {
      background: #fdfdfd;
    }

    .footer-note {
      font-size: 0.75rem;
      color: var(--muted);
      margin-top: 6px;
    }

    /* Summary section */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin: 10px 0 10px;
    }

    .summary-box {
      border-radius: 14px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      padding: 8px 10px;
      font-size: 0.8rem;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .summary-title {
      font-weight: 700;
      font-size: 0.8rem;
      color: #111827;
    }

    .summary-list {
      margin: 0;
      padding-left: 16px;
    }

    .summary-list li {
      margin-bottom: 2px;
    }

    /* Accordion */
    #accordionContent {
      display: none;
      margin-top: 12px;
    }

    #toggleAccordionBtn {
      margin-top: 6px;
    }

    /* Logo */
    .logo-wrap {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo {
      width: 46px;
      height: 46px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #22c55e;
      background: #bbf7d0;
      display: block;
    }

    .logo-fallback {
      width: 46px;
      height: 46px;
      border-radius: 50%;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #f0fdf4;
      font-weight: 800;
      font-size: 1rem;
      border: 2px solid #22c55e;
    }

    @media (max-width: 900px) {
      .summary-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 768px) {
      .card-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .quick-counter {
        grid-template-columns: 1fr 1fr;
      }

      .row {
        flex-direction: row;
        flex-wrap: wrap;
      }

      .summary-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 10px;
      }

      .card {
        padding: 14px 12px 16px;
      }

      table {
        font-size: 0.7rem;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- HEADER / CONTROLS -->
    <div class="card">
      <div class="card-header">
        <div class="logo-wrap">
          <!-- Replace src with your actual 2GO logo file if different -->
          <img src="2go-logo.png" alt="2GO Logo" class="logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
          <div class="logo-fallback" style="display:none;">2GO</div>
          <div>
            <h1>2GO Store Footfall</h1>
            <div class="subtle">
              Simple: <strong>tap one button per customer</strong>. Time is automatic.
            </div>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="dateInput" class="inline-label">Day</label>
            <input type="date" id="dateInput" />
            <div class="subtle" style="font-size:0.8rem;margin-top:2px;">
              Keep this on <strong>today</strong> in normal use.
            </div>
          </div>
        </div>
      </div>

      <div>
        <div id="currentHourLabel" class="current-hour-label">
          <span class="badge">LIVE</span>
          <span>Current hour: 06:00 – 06:59</span>
        </div>
      </div>

      <!-- QUICK STATS -->
      <div class="row" style="margin-bottom: 6px;margin-top:10px;">
        <div class="quick-counter">
          <div class="quick-stat quick-stat--hour">
            <span class="label">This hour</span>
            <span id="currentHourTotal" class="value">0</span>
          </div>
          <div class="quick-stat quick-stat--day">
            <span class="label">Today (6am–9pm)</span>
            <span id="todayTotal" class="value">0</span>
          </div>
        </div>
      </div>

      <!-- AGE BUTTONS -->
      <div style="margin-top:8px;">
        <h2>Tap an age range</h2>
        <div class="subtle">
          Pick the <strong>closest age bracket</strong> for each customer who walks in.
        </div>
        <div class="age-grid" id="ageButtonsContainer">
          <!-- Filled by JS -->
        </div>
      </div>
    </div>

    <!-- INSIGHTS / HISTORY (ACCORDION) -->
    <div class="card">
      <div class="card-header">
        <div>
          <h2>Insights & history</h2>
          <div class="subtle" id="tableDateLabel"></div>
        </div>
        <div class="row">
          <button id="exportCsvBtn" class="btn btn-outline btn-sm">
            Export CSV
          </button>
          <button id="resetDayBtn" class="btn btn-danger btn-sm">
            Reset this day
          </button>
        </div>
      </div>

      <button id="toggleAccordionBtn" class="btn btn-soft btn-block">
        Show insights & history ▼
      </button>

      <div id="accordionContent">
        <!-- SUMMARY SECTION -->
        <div id="summarySection" class="summary-grid">
          <!-- Filled by JS -->
        </div>

        <div class="table-wrapper">
          <table id="summaryTable">
            <!-- built by JS -->
          </table>
        </div>
        <div class="footer-note">
          Tip: Export to Google Sheets / Excel weekly to compare days.
        </div>
      </div>
    </div>
  </div>

  <script>
    // --------- CONFIG ---------
    const AGE_GROUPS = [
      { key: "child", label: "Child" },
      { key: "teen", label: "Teenager" },
      { key: "young_adult", label: "Young Adult (20+)" },
      { key: "adult_30", label: "Adult 30+" },
      { key: "senior_60", label: "Senior (60+)" }
    ];

    // Opening hours: 6am–9pm (21:59)
    const OPEN_HOUR = 6;
    const CLOSE_HOUR = 21;

    // Threshold for "cold" hours (very low footfall)
    const COLD_THRESHOLD = 2;

    const STORAGE_KEY = "footfall_age_data_v1";

    // Data structure:
    // {
    //   "YYYY-MM-DD": {
    //     "6": { total: 0, ageGroups: { key: count } },
    //     ...
    //     "21": ...
    //   }
    // }
    let data = loadData();

    const dateInput = document.getElementById("dateInput");
    const currentHourLabelEl = document.getElementById("currentHourLabel");
    const currentHourTotalEl = document.getElementById("currentHourTotal");
    const todayTotalEl = document.getElementById("todayTotal");
    const ageButtonsContainer = document.getElementById("ageButtonsContainer");
    const summaryTable = document.getElementById("summaryTable");
    const tableDateLabel = document.getElementById("tableDateLabel");
    const exportCsvBtn = document.getElementById("exportCsvBtn");
    const resetDayBtn = document.getElementById("resetDayBtn");
    const summarySection = document.getElementById("summarySection");
    const toggleAccordionBtn = document.getElementById("toggleAccordionBtn");
    const accordionContent = document.getElementById("accordionContent");

    let accordionOpen = false;

    init();

    function init() {
      initDateDefault();
      renderAgeButtons();
      refreshUI();

      dateInput.addEventListener("change", () => {
        ensureDayStructure(getSelectedDate());
        refreshUI();
      });

      exportCsvBtn.addEventListener("click", exportCsv);
      resetDayBtn.addEventListener("click", resetDayConfirm);

      toggleAccordionBtn.addEventListener("click", () => {
        accordionOpen = !accordionOpen;
        accordionContent.style.display = accordionOpen ? "block" : "none";
        toggleAccordionBtn.textContent = accordionOpen
          ? "Hide insights & history ▲"
          : "Show insights & history ▼";
      });

      // Update hour label every minute in case time changes while open
      setInterval(() => {
        updateCurrentHourLabel();
        refreshQuickStatsOnly();
      }, 60000);
    }

    function initDateDefault() {
      const today = new Date();
      const iso = today.toISOString().slice(0, 10);
      dateInput.value = iso;
      ensureDayStructure(iso);
    }

    function getSelectedDate() {
      return dateInput.value || new Date().toISOString().slice(0, 10);
    }

    function getCurrentHourForDate(date) {
      const todayIso = new Date().toISOString().slice(0, 10);
      let hour;
      if (date === todayIso) {
        hour = new Date().getHours();
      } else {
        // For past/future days, just show opening hour in "This hour" box
        hour = OPEN_HOUR;
      }
      if (hour < OPEN_HOUR) hour = OPEN_HOUR;
      if (hour > CLOSE_HOUR) hour = CLOSE_HOUR;
      return hour;
    }

    function updateCurrentHourLabel() {
      const date = getSelectedDate();
      const hour = getCurrentHourForDate(date);
      const labelSpan = currentHourLabelEl.querySelector("span:nth-child(2)");
      if (labelSpan) {
        labelSpan.textContent = "Current hour: " + formatHourRange(hour);
      }
    }

    function renderAgeButtons() {
      ageButtonsContainer.innerHTML = "";
      AGE_GROUPS.forEach((group) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "age-btn " + group.key;
        btn.dataset.ageKey = group.key;

        btn.innerHTML = `
          <span class="label">${group.label}</span>
          <span class="count">0 this hour</span>
        `;

        btn.addEventListener("click", () => {
          incrementCurrent(group.key);
        });

        ageButtonsContainer.appendChild(btn);
      });
    }

    function incrementCurrent(ageKey) {
      const date = getSelectedDate();
      const hour = getCurrentHourForDate(date);
      ensureDayStructure(date);
      ensureHourStructure(date, hour);

      const hourData = data[date][hour];
      hourData.total += 1;
      if (!hourData.ageGroups[ageKey]) hourData.ageGroups[ageKey] = 0;
      hourData.ageGroups[ageKey] += 1;

      saveData();
      refreshUI();
      flashAgeButton(ageKey);
    }

    function flashAgeButton(ageKey) {
      const btn = ageButtonsContainer.querySelector(
        `[data-age-key="${ageKey}"]`
      );
      if (!btn) return;
      btn.classList.add("highlight");
      setTimeout(() => btn.classList.remove("highlight"), 140);
    }

    function ensureDayStructure(date) {
      if (!data[date]) {
        data[date] = {};
        for (let h = OPEN_HOUR; h <= CLOSE_HOUR; h++) {
          data[date][h] = {
            total: 0,
            ageGroups: {}
          };
        }
        saveData();
      }
    }

    function ensureHourStructure(date, hour) {
      ensureDayStructure(date);
      if (!data[date][hour]) {
        data[date][hour] = {
          total: 0,
          ageGroups: {}
        };
        saveData();
      }
    }

    function refreshQuickStatsOnly() {
      const date = getSelectedDate();
      ensureDayStructure(date);
      const hour = getCurrentHourForDate(date);
      ensureHourStructure(date, hour);
      const dayData = data[date];
      const hourData = dayData[hour];

      // Update hour label & current hour total
      updateCurrentHourLabel();
      currentHourTotalEl.textContent = hourData.total;

      // Today total
      let todayTotal = 0;
      for (let h = OPEN_HOUR; h <= CLOSE_HOUR; h++) {
        todayTotal += (dayData[h]?.total || 0);
      }
      todayTotalEl.textContent = todayTotal;

      // Age button counts for this hour
      AGE_GROUPS.forEach((group) => {
        const btn = ageButtonsContainer.querySelector(
          `[data-age-key="${group.key}"]`
        );
        if (!btn) return;
        const count = hourData.ageGroups[group.key] || 0;
        const spanCount = btn.querySelector(".count");
        spanCount.textContent = `${count} this hour`;
      });
    }

    function refreshUI() {
      const date = getSelectedDate();
      ensureDayStructure(date);
      const hour = getCurrentHourForDate(date);
      ensureHourStructure(date, hour);
      const dayData = data[date];

      // Label for date
      tableDateLabel.textContent = `Data for ${date} (6am–9pm)`;

      refreshQuickStatsOnly();

      // Table + summary
      renderTable(date);
      renderSummary(date);
    }

    function renderTable(date) {
      ensureDayStructure(date);
      const dayData = data[date];

      let html = "<thead><tr>";
      html += "<th>Hour</th>";
      html += "<th>Total</th>";
      AGE_GROUPS.forEach((g) => {
        html += `<th>${g.label}</th>`;
      });
      html += "</tr></thead><tbody>";

      for (let h = OPEN_HOUR; h <= CLOSE_HOUR; h++) {
        const hourData = dayData[h] || { total: 0, ageGroups: {} };
        html += "<tr>";
        html += `<td>${formatHourRange(h)}</td>`;
        html += `<td>${hourData.total || 0}</td>`;
        AGE_GROUPS.forEach((g) => {
          const val = hourData.ageGroups[g.key] || 0;
          html += `<td>${val}</td>`;
        });
        html += "</tr>";
      }

      html += "</tbody>";
      summaryTable.innerHTML = html;
    }

    function renderSummary(date) {
      ensureDayStructure(date);
      const dayData = data[date];

      // Calculate overall total to see if any data exists
      let overallTotal = 0;
      for (let h = OPEN_HOUR; h <= CLOSE_HOUR; h++) {
        overallTotal += (dayData[h]?.total || 0);
      }

      if (overallTotal === 0) {
        summarySection.innerHTML =
          '<div class="summary-box"><div class="summary-title">No data yet</div><div class="subtle">Start tapping customers to see busiest ages and cold hours.</div></div>';
        return;
      }

      // 1) Busiest hour by age group
      const busiestByAge = [];
      AGE_GROUPS.forEach((g) => {
        let bestHour = null;
        let bestCount = 0;
        for (let h = OPEN_HOUR; h <= CLOSE_HOUR; h++) {
          const count = (dayData[h]?.ageGroups?.[g.key]) || 0;
          if (count > bestCount) {
            bestCount = count;
            bestHour = h;
          }
        }
        if (bestHour !== null && bestCount > 0) {
          busiestByAge.push({
            label: g.label,
            hour: bestHour,
            count: bestCount
          });
        }
      });

      // 2) Cold hours (very low footfall)
      const coldHours = [];
      for (let h = OPEN_HOUR; h <= CLOSE_HOUR; h++) {
        const total = (dayData[h]?.total || 0);
        if (total <= COLD_THRESHOLD) {
          coldHours.push({ hour: h, total });
        }
      }

      // 3) Overall busiest hours (top 3)
      const allHours = [];
      for (let h = OPEN_HOUR; h <= CLOSE_HOUR; h++) {
        allHours.push({ hour: h, total: (dayData[h]?.total || 0) });
      }
      allHours.sort((a, b) => b.total - a.total);
      const busiestOverall = allHours
        .filter(item => item.total > 0)
        .slice(0, 3);

      // Build HTML
      let html = "";

      // Box 1: Busiest by age
      html += '<div class="summary-box">';
      html += '<div class="summary-title">Busiest times by age group</div>';
      if (busiestByAge.length === 0) {
        html += '<div class="subtle">No age data yet – start tagging ages.</div>';
      } else {
        html += '<ul class="summary-list">';
        busiestByAge.forEach(item => {
          html += `<li>${item.label}: ${formatHourRange(item.hour)} (${item.count})</li>`;
        });
        html += '</ul>';
      }
      html += '</div>';

      // Box 2: Cold hours
      html += '<div class="summary-box">';
      html += `<div class="summary-title">Cold hours (≤ ${COLD_THRESHOLD} customers)</div>`;
      if (coldHours.length === 0) {
        html += '<div class="subtle">No cold hours today – nice and steady.</div>';
      } else {
        html += '<ul class="summary-list">';
        coldHours.forEach(item => {
          html += `<li>${formatHourRange(item.hour)} (${item.total})</li>`;
        });
        html += '</ul>';
      }
      html += '</div>';

      // Box 3: Overall busiest
      html += '<div class="summary-box">';
      html += '<div class="summary-title">Overall busiest hours</div>';
      if (busiestOverall.length === 0) {
        html += '<div class="subtle">No customers recorded yet.</div>';
      } else {
        html += '<ul class="summary-list">';
        busiestOverall.forEach(item => {
          html += `<li>${formatHourRange(item.hour)} (${item.total})</li>`;
        });
        html += '</ul>';
      }
      html += '</div>';

      summarySection.innerHTML = html;
    }

    function loadData() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return {};
        return JSON.parse(raw) || {};
      } catch (e) {
        console.error("Failed to load data", e);
        return {};
      }
    }

    function saveData() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      } catch (e) {
        console.error("Failed to save data", e);
      }
    }

    function formatHourRange(h) {
      const start = String(h).padStart(2, "0") + ":00";
      const end = String(h).padStart(2, "0") + ":59";
      return `${start} – ${end}`;
    }

    function exportCsv() {
      const date = getSelectedDate();
      ensureDayStructure(date);
      const dayData = data[date];

      const headers = ["date", "hour", "total"].concat(
        AGE_GROUPS.map((g) => g.key)
      );

      const rows = [headers];

      for (let h = OPEN_HOUR; h <= CLOSE_HOUR; h++) {
        const hourData = dayData[h] || { total: 0, ageGroups: {} };
        const row = [];
        row.push(date);
        row.push(`${String(h).padStart(2, "0")}:00`);
        row.push(hourData.total || 0);
        AGE_GROUPS.forEach((g) => {
          row.push(hourData.ageGroups[g.key] || 0);
        });
        rows.push(row);
      }

      const csvContent = rows
        .map((row) =>
          row
            .map((cell) => {
              const str = String(cell).replace(/"/g, '""');
              return `"${str}"`;
            })
            .join(",")
        )
        .join("\n");

      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", `footfall_${date}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    function resetDayConfirm() {
      const date = getSelectedDate();
      const ok = confirm(
        `Reset ALL data for ${date}? This cannot be undone.`
      );
      if (!ok) return;
      data[date] = {};
      for (let h = OPEN_HOUR; h <= CLOSE_HOUR; h++) {
        data[date][h] = {
          total: 0,
          ageGroups: {}
        };
      }
      saveData();
      refreshUI();
    }

    // Call once at start
    updateCurrentHourLabel();
  </script>
</body>
</html>
